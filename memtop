#!/bin/bash

# Установка значения NUM в зависимости от аргумента командной строки
if [[ $# -eq 0 ]]; then
    NUM=10
elif [[ $1 -gt 0 ]]; then
    NUM=$1
else
    # Вывод сообщения об использовании скрипта в случае некорректного аргумента
    echo "Usage: memtop [N]"
    echo "N - number of top processes to display"
    exit 1
fi

# Получение списка процессов с сортировкой по использованию памяти и извлечение нужных данных
ps aux --sort=-%mem | \
    awk -v num="$NUM" 'NR > 1 {
        # Разделение команды на массив для получения названия процесса
        split($11, arr, "/")
        # Добавление объема использованной памяти в массив для каждого процесса
        mem[arr[length(arr)]] += $6
    } END {
	total=0
        # Вычисление общего объема использованной памяти всех процессов
        for (cmd in mem) total += mem[cmd]
        # Вывод топ NUM процессов с их объемом памяти и процентом от общего объема
        for (cmd in mem) printf "%-20s %6.1f MB %5.1f%%\n", cmd, mem[cmd] / 1024, (mem[cmd] / total) * 100
    }' | \
    # Сортировка вывода по объему памяти и ограничение вывода NUM строк
    sort -k2,2rn | \
    head -n "$NUM" | \
    column -t
